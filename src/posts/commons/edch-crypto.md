---
title: EDCH——一种在不可靠链路上进行加密的协议
isOriginal: true
category:
    - 计算机
    - 加密
---

本文介绍了一种在不可靠链路上进行加密的协议——EDCH。

<!-- more -->

## 背景

客户需要我们系统中的某个文件，然后发邮件发给客户，客户再导入他们自己的系统中，这就需要我们把文件加密后再发给客户，客户再解密，但是邮件是不安全的，因此需要一种在不可靠链路上进行加密的协议。

## 加解密流程

### 协议概述

EDCH（Enhanced Diffie-Hellman with Certificate）协议结合了椭圆曲线Diffie-Hellman密钥交换和数字证书认证，确保在不可靠信道上的安全通信。该协议具有前向安全性，即使长期密钥泄露，历史会话数据仍然安全。

### 详细流程

准备阶段：
1. 证书准备：服务端事先申请数字证书，妥善保存证书及对应的公私钥对

加密阶段：
2. 客户端密钥生成：客户端生成临时ECDH密钥对，将公钥发送给服务端，私钥本地保存
3. 服务端密钥交换：服务端生成临时ECDH密钥对，使用客户端公钥计算ECDH共享密钥，并用证书私钥对服务端ECDH公钥进行数字签名
4. 文件加密：使用共享密钥通过HKDF派生AES-256-GCM加密密钥，加密目标文件，生成加密包（包含：加密数据、服务端证书、服务端ECDH公钥、公钥签名、AES初始化向量IV、GCM认证标签）

解密阶段：
5. 证书验证：客户端验证服务端证书的有效期和签名链，确认证书可信性，并验证服务端ECDH公钥的数字签名
6. 密钥恢复与解密：使用服务端ECDH公钥与客户端ECDH私钥重新计算共享密钥，派生相同的AES-256-GCM解密密钥，解密数据并验证GCM认证标签的完整性

### 加密流程图

```mermaid
flowchart LR
    A[客户端] --> B[生成临时ECDH密钥对]
    B --> C[发送公钥给服务端]
    C --> D[服务端]
    D --> E[生成临时ECDH密钥对]
    E --> F[计算ECDH共享密钥]
    F --> G[用证书私钥签名服务端公钥]
    G --> H[派生AES-256-GCM密钥]
    H --> I[加密文件]
    I --> J[生成加密包]
    J --> K[返回给客户端]
    
    style A fill:#e1f5fe
    style D fill:#f3e5f5
    style J fill:#e8f5e8
```

### 解密流程图

```mermaid
flowchart LR
    A[客户端接收加密包] --> B[验证服务端证书]
    B --> C[验证ECDH公钥签名]
    C --> D[使用服务端公钥+客户端私钥]
    D --> E[重新计算ECDH共享密钥]
    E --> F[派生相同AES-256-GCM密钥]
    F --> G[解密数据]
    G --> H[验证GCM认证标签]
    H --> I[获得原始文件]
    
    style A fill:#fff3e0
    style I fill:#e8f5e8
    style H fill:#ffebee
```

::: tip 安全性
- 前向安全性：每次会话使用临时密钥对，历史数据不会因长期密钥泄露而受影响
- 身份认证：通过数字证书确保服务端身份的可信性
- 完整性保护：AES-GCM模式提供加密和认证的双重保护
- 抗重放攻击：临时密钥和随机IV确保每次加密结果唯一
:::

